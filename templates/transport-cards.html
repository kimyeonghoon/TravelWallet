<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµí†µì¹´ë“œ ì”ì•¡ ê´€ë¦¬ - Japan Travel Expense</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .transport-card {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #f8f9fa;
        }
        .card-name {
            font-weight: bold;
            font-size: 1.1rem;
        }
        .card-balance {
            font-size: 1.25rem;
            color: #0d6efd;
            font-weight: bold;
        }
        .total-balance {
            background: linear-gradient(135deg, #0d6efd, #0dcaf0);
            color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">ğŸ‡¯ğŸ‡µ Japan Travel Expense</a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">ì§€ì¶œ ë‚´ì—­</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/statistics">í†µê³„</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/transport-cards">êµí†µì¹´ë“œ</a>
                    </li>
                </ul>
                
                <div class="navbar-nav">
                    {% if user %}
                        <span class="navbar-text me-3">ì•ˆë…•í•˜ì„¸ìš”!</span>
                        <button class="btn btn-outline-light btn-sm" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                    {% else %}
                        <button class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#loginModal">ë¡œê·¸ì¸</button>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <h2 class="mb-4">êµí†µì¹´ë“œ ì”ì•¡ ê´€ë¦¬</h2>

                <!-- Total Balance Summary -->
                <div class="total-balance text-center" id="totalBalanceCard">
                    <h4 class="mb-2">ì´ êµí†µì¹´ë“œ ì”ì•¡</h4>
                    <h2 class="mb-0" id="totalBalance">Â¥0</h2>
                </div>

                <!-- Add Card Button (only for authenticated users) -->
                {% if user %}
                <div class="mb-3">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCardModal">
                        <i class="bi bi-plus-circle"></i> ì¹´ë“œ ì¶”ê°€
                    </button>
                </div>
                {% endif %}

                <!-- Transport Cards List -->
                <div id="transportCardsList">
                    <!-- Cards will be loaded here -->
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="text-center py-5" style="display: none;">
                    <h5 class="text-muted">ë“±ë¡ëœ êµí†µì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤</h5>
                    {% if user %}
                    <p class="text-muted">ìœ„ì˜ "ì¹´ë“œ ì¶”ê°€" ë²„íŠ¼ì„ ëˆŒëŸ¬ ì²« ë²ˆì§¸ ì¹´ë“œë¥¼ ë“±ë¡í•˜ì„¸ìš”.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Add Card Modal -->
    <div class="modal fade" id="addCardModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">êµí†µì¹´ë“œ ì¶”ê°€</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addCardForm">
                        <div class="mb-3">
                            <label for="cardName" class="form-label">ì¹´ë“œëª… *</label>
                            <input type="text" class="form-control" id="cardName" required 
                                   placeholder="ì˜ˆ: Suica, PASMO, ICOCA">
                        </div>
                        <div class="mb-3">
                            <label for="cardBalance" class="form-label">ì”ì•¡ (Â¥)</label>
                            <input type="number" class="form-control" id="cardBalance" 
                                   min="0" step="0.01" value="0" placeholder="0">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-primary" onclick="addCard()">ì¶”ê°€</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Card Modal -->
    <div class="modal fade" id="editCardModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">êµí†µì¹´ë“œ ìˆ˜ì •</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editCardForm">
                        <input type="hidden" id="editCardId">
                        <div class="mb-3">
                            <label for="editCardName" class="form-label">ì¹´ë“œëª… *</label>
                            <input type="text" class="form-control" id="editCardName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editCardBalance" class="form-label">ì”ì•¡ (Â¥)</label>
                            <input type="number" class="form-control" id="editCardBalance" 
                                   min="0" step="0.01">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-primary" onclick="updateCard()">ìˆ˜ì •</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal (same as in index.html) -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ë¡œê·¸ì¸</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="loginStep1">
                        <p class="text-muted">ë“±ë¡ëœ ì´ë©”ì¼ì„ ì…ë ¥í•˜ë©´ í…”ë ˆê·¸ë¨ìœ¼ë¡œ ì¸ì¦ ì½”ë“œë¥¼ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.</p>
                        <div class="mb-3">
                            <label for="loginEmail" class="form-label">ì´ë©”ì¼</label>
                            <input type="email" class="form-control" id="loginEmail" required>
                        </div>
                        <button type="button" class="btn btn-primary w-100" onclick="requestLoginCode()">ì¸ì¦ ì½”ë“œ ìš”ì²­</button>
                    </div>
                    
                    <div id="loginStep2" style="display: none;">
                        <p class="text-muted">í…”ë ˆê·¸ë¨ìœ¼ë¡œ ë°›ì€ 6ìë¦¬ ì¸ì¦ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
                        <div class="mb-3">
                            <label for="loginCode" class="form-label">ì¸ì¦ ì½”ë“œ</label>
                            <input type="text" class="form-control" id="loginCode" maxlength="6" required>
                        </div>
                        <button type="button" class="btn btn-primary w-100" onclick="verifyLoginCode()">ë¡œê·¸ì¸</button>
                        <button type="button" class="btn btn-link w-100" onclick="backToStep1()">ë‹¤ë¥¸ ì´ë©”ì¼ ì‚¬ìš©</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/jquery-3.6.0.min.js"></script>
    <script>
        // Global variables
        let isAuthenticated = {% if user %}true{% else %}false{% endif %};

        // Load transport cards on page load
        $(document).ready(function() {
            loadTransportCards();
            loadTotalBalance();
        });

        // Load all transport cards
        function loadTransportCards() {
            fetch('/api/transport-cards')
                .then(response => response.json())
                .then(cards => {
                    displayTransportCards(cards);
                })
                .catch(error => {
                    console.error('Error loading transport cards:', error);
                    showAlert('êµí†µì¹´ë“œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
                });
        }

        // Display transport cards in the UI
        function displayTransportCards(cards) {
            const cardsList = document.getElementById('transportCardsList');
            const emptyState = document.getElementById('emptyState');
            
            if (cards.length === 0) {
                cardsList.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            cardsList.innerHTML = cards.map(card => `
                <div class="transport-card" data-card-id="${card.id}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="card-name">${escapeHtml(card.name)}</div>
                            <div class="card-balance">Â¥${formatNumber(card.balance)}</div>
                            <small class="text-muted">
                                ìƒì„±: ${formatDate(card.created_at)} | 
                                ìˆ˜ì •: ${formatDate(card.updated_at)}
                            </small>
                        </div>
                        ${isAuthenticated ? `
                        <div class="btn-group">
                            <button class="btn btn-outline-primary btn-sm" onclick="editCard(${card.id}, '${escapeHtml(card.name)}', ${card.balance})">
                                ìˆ˜ì •
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteCard(${card.id}, '${escapeHtml(card.name)}')">
                                ì‚­ì œ
                            </button>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Load total balance
        function loadTotalBalance() {
            fetch('/api/transport-cards/summary')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalBalance').textContent = `Â¥${formatNumber(data.total_balance)}`;
                })
                .catch(error => {
                    console.error('Error loading total balance:', error);
                });
        }

        // Add new card
        function addCard() {
            const name = document.getElementById('cardName').value.trim();
            const balance = parseFloat(document.getElementById('cardBalance').value) || 0;
            
            if (!name) {
                showAlert('ì¹´ë“œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            fetch('/api/transport-cards', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    balance: balance
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to add card');
                }
                return response.json();
            })
            .then(card => {
                showAlert('êµí†µì¹´ë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                document.getElementById('addCardForm').reset();
                bootstrap.Modal.getInstance(document.getElementById('addCardModal')).hide();
                loadTransportCards();
                loadTotalBalance();
            })
            .catch(error => {
                console.error('Error adding card:', error);
                showAlert('êµí†µì¹´ë“œ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
            });
        }

        // Edit card
        function editCard(id, name, balance) {
            document.getElementById('editCardId').value = id;
            document.getElementById('editCardName').value = name;
            document.getElementById('editCardBalance').value = balance;
            
            const modal = new bootstrap.Modal(document.getElementById('editCardModal'));
            modal.show();
        }

        // Update card
        function updateCard() {
            const id = document.getElementById('editCardId').value;
            const name = document.getElementById('editCardName').value.trim();
            const balance = parseFloat(document.getElementById('editCardBalance').value);
            
            if (!name) {
                showAlert('ì¹´ë“œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            fetch(`/api/transport-cards/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    balance: balance
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update card');
                }
                return response.json();
            })
            .then(card => {
                showAlert('êµí†µì¹´ë“œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                bootstrap.Modal.getInstance(document.getElementById('editCardModal')).hide();
                loadTransportCards();
                loadTotalBalance();
            })
            .catch(error => {
                console.error('Error updating card:', error);
                showAlert('êµí†µì¹´ë“œ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
            });
        }

        // Delete card
        function deleteCard(id, name) {
            if (!confirm(`'${name}' ì¹´ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }
            
            fetch(`/api/transport-cards/${id}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to delete card');
                }
                return response.json();
            })
            .then(() => {
                showAlert('êµí†µì¹´ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                loadTransportCards();
                loadTotalBalance();
            })
            .catch(error => {
                console.error('Error deleting card:', error);
                showAlert('êµí†µì¹´ë“œ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
            });
        }

        // Login functions (same as in index.html)
        function requestLoginCode() {
            const email = document.getElementById('loginEmail').value.trim();
            
            if (!email) {
                showAlert('ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            fetch('/api/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email: email })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    showAlert(data.message, 'success');
                    document.getElementById('loginStep1').style.display = 'none';
                    document.getElementById('loginStep2').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('ë¡œê·¸ì¸ ì½”ë“œ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
            });
        }

        function verifyLoginCode() {
            const code = document.getElementById('loginCode').value.trim();
            
            if (!code) {
                showAlert('ì¸ì¦ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            fetch('/api/auth/verify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ code: code })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === 'Login successful') {
                    showAlert('ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showAlert('ì˜ëª»ëœ ì¸ì¦ ì½”ë“œì…ë‹ˆë‹¤.', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
            });
        }

        function backToStep1() {
            document.getElementById('loginStep1').style.display = 'block';
            document.getElementById('loginStep2').style.display = 'none';
            document.getElementById('loginCode').value = '';
        }

        function logout() {
            fetch('/api/auth/logout', { method: 'POST' })
                .then(() => {
                    showAlert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    setTimeout(() => location.reload(), 1000);
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('ë¡œê·¸ì•„ì›ƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
                });
        }

        // Utility functions
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        function formatNumber(num) {
            return parseFloat(num).toLocaleString('ja-JP', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            });
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>