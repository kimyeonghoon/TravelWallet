<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>교통카드 잔액 관리 - Japan Travel Expense</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/font-awesome.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .transport-card {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #f8f9fa;
        }
        .card-name {
            font-weight: bold;
            font-size: 1.1rem;
        }
        .card-balance {
            font-size: 1.25rem;
            color: #0d6efd;
            font-weight: bold;
        }
        .total-balance {
            background: linear-gradient(135deg, #0d6efd, #0dcaf0);
            color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="/">
                    <i class="fas fa-yen-sign me-2"></i>일본 여행 경비
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="/"><i class="fas fa-home me-1"></i>홈</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/statistics"><i class="fas fa-chart-bar me-1"></i>통계</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/transport-cards"><i class="fas fa-subway me-1"></i>교통카드</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/wallets"><i class="fas fa-wallet me-1"></i>엔화지갑</a>
                        </li>
                        {% if user %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fab fa-telegram-plane me-1"></i>{{ user.telegram_chat_id }}
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" id="logout-btn">
                                    <i class="fas fa-sign-out-alt me-2"></i>로그아웃
                                </a></li>
                            </ul>
                        </li>
                        {% else %}
                        <li class="nav-item">
                            <button class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#loginModal">
                                <i class="fab fa-telegram-plane me-1"></i>로그인
                            </button>
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <h2 class="mb-4">교통카드 잔액 관리</h2>

                <!-- Total Balance Summary -->
                <div class="total-balance text-center" id="totalBalanceCard">
                    <h4 class="mb-2">총 교통카드 잔액</h4>
                    <h2 class="mb-0" id="totalBalance">¥0</h2>
                </div>

                <!-- Add Card Button (only for authenticated users) -->
                {% if user %}
                <div class="mb-3">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCardModal">
                        <i class="bi bi-plus-circle"></i> 카드 추가
                    </button>
                </div>
                {% endif %}

                <!-- Transport Cards List -->
                <div id="transportCardsList">
                    <!-- Cards will be loaded here -->
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="text-center py-5" style="display: none;">
                    <h5 class="text-muted">등록된 교통카드가 없습니다</h5>
                    {% if user %}
                    <p class="text-muted">위의 "카드 추가" 버튼을 눌러 첫 번째 카드를 등록하세요.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Add Card Modal -->
    <div class="modal fade" id="addCardModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">교통카드 추가</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addCardForm">
                        <div class="mb-3">
                            <label for="cardName" class="form-label">카드명 *</label>
                            <input type="text" class="form-control" id="cardName" required 
                                   placeholder="예: Suica, PASMO, ICOCA">
                        </div>
                        <div class="mb-3">
                            <label for="cardBalance" class="form-label">잔액 (¥)</label>
                            <input type="number" class="form-control" id="cardBalance" 
                                   min="0" step="0.01" value="0" placeholder="0">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="addCard()">추가</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Card Modal -->
    <div class="modal fade" id="editCardModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">교통카드 수정</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editCardForm">
                        <input type="hidden" id="editCardId">
                        <div class="mb-3">
                            <label for="editCardName" class="form-label">카드명 *</label>
                            <input type="text" class="form-control" id="editCardName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editCardBalance" class="form-label">잔액 (¥)</label>
                            <input type="number" class="form-control" id="editCardBalance" 
                                   min="0" step="0.01">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="updateCard()">수정</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal (same as in index.html) -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">로그인</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="loginStep1">
                        <p class="text-muted">등록된 이메일을 입력하면 텔레그램으로 인증 코드를 보내드립니다.</p>
                        <div class="mb-3">
                            <label for="loginEmail" class="form-label">이메일</label>
                            <input type="email" class="form-control" id="loginEmail" required>
                        </div>
                        <button type="button" class="btn btn-primary w-100" onclick="requestLoginCode()">인증 코드 요청</button>
                    </div>
                    
                    <div id="loginStep2" style="display: none;">
                        <p class="text-muted">텔레그램으로 받은 6자리 인증 코드를 입력하세요.</p>
                        <div class="mb-3">
                            <label for="loginCode" class="form-label">인증 코드</label>
                            <input type="text" class="form-control" id="loginCode" maxlength="6" required>
                        </div>
                        <button type="button" class="btn btn-primary w-100" onclick="verifyLoginCode()">로그인</button>
                        <button type="button" class="btn btn-link w-100" onclick="backToStep1()">다른 이메일 사용</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/jquery-3.6.0.min.js"></script>
    <script>
        // Global variables
        let isAuthenticated = {% if user %}true{% else %}false{% endif %};

        // Load transport cards on page load
        $(document).ready(function() {
            loadTransportCards();
            loadTotalBalance();
        });

        // Load all transport cards
        function loadTransportCards() {
            fetch('/api/transport-cards')
                .then(response => response.json())
                .then(cards => {
                    displayTransportCards(cards);
                })
                .catch(error => {
                    console.error('Error loading transport cards:', error);
                    showAlert('교통카드 목록을 불러오는데 실패했습니다.', 'danger');
                });
        }

        // Display transport cards in the UI
        function displayTransportCards(cards) {
            const cardsList = document.getElementById('transportCardsList');
            const emptyState = document.getElementById('emptyState');
            
            if (cards.length === 0) {
                cardsList.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            cardsList.innerHTML = cards.map(card => `
                <div class="transport-card" data-card-id="${card.id}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="card-name">${escapeHtml(card.name)}</div>
                            <div class="card-balance">¥${formatNumber(card.balance)}</div>
                            <small class="text-muted">
                                생성: ${formatDate(card.created_at)} | 
                                수정: ${formatDate(card.updated_at)}
                            </small>
                        </div>
                        ${isAuthenticated ? `
                        <div class="btn-group">
                            <button class="btn btn-outline-primary btn-sm" onclick="editCard(${card.id}, '${escapeHtml(card.name)}', ${card.balance})">
                                수정
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteCard(${card.id}, '${escapeHtml(card.name)}')">
                                삭제
                            </button>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Load total balance
        function loadTotalBalance() {
            fetch('/api/transport-cards/summary')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalBalance').textContent = `¥${formatNumber(data.total_balance)}`;
                })
                .catch(error => {
                    console.error('Error loading total balance:', error);
                });
        }

        // Add new card
        function addCard() {
            const name = document.getElementById('cardName').value.trim();
            const balance = parseFloat(document.getElementById('cardBalance').value) || 0;
            
            if (!name) {
                showAlert('카드명을 입력해주세요.', 'warning');
                return;
            }
            
            fetch('/api/transport-cards', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    balance: balance
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to add card');
                }
                return response.json();
            })
            .then(card => {
                showAlert('교통카드가 추가되었습니다.', 'success');
                document.getElementById('addCardForm').reset();
                bootstrap.Modal.getInstance(document.getElementById('addCardModal')).hide();
                loadTransportCards();
                loadTotalBalance();
            })
            .catch(error => {
                console.error('Error adding card:', error);
                showAlert('교통카드 추가에 실패했습니다.', 'danger');
            });
        }

        // Edit card
        function editCard(id, name, balance) {
            document.getElementById('editCardId').value = id;
            document.getElementById('editCardName').value = name;
            document.getElementById('editCardBalance').value = balance;
            
            const modal = new bootstrap.Modal(document.getElementById('editCardModal'));
            modal.show();
        }

        // Update card
        function updateCard() {
            const id = document.getElementById('editCardId').value;
            const name = document.getElementById('editCardName').value.trim();
            const balance = parseFloat(document.getElementById('editCardBalance').value);
            
            if (!name) {
                showAlert('카드명을 입력해주세요.', 'warning');
                return;
            }
            
            fetch(`/api/transport-cards/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    balance: balance
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update card');
                }
                return response.json();
            })
            .then(card => {
                showAlert('교통카드가 수정되었습니다.', 'success');
                bootstrap.Modal.getInstance(document.getElementById('editCardModal')).hide();
                loadTransportCards();
                loadTotalBalance();
            })
            .catch(error => {
                console.error('Error updating card:', error);
                showAlert('교통카드 수정에 실패했습니다.', 'danger');
            });
        }

        // Delete card
        function deleteCard(id, name) {
            if (!confirm(`'${name}' 카드를 삭제하시겠습니까?`)) {
                return;
            }
            
            fetch(`/api/transport-cards/${id}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to delete card');
                }
                return response.json();
            })
            .then(() => {
                showAlert('교통카드가 삭제되었습니다.', 'success');
                loadTransportCards();
                loadTotalBalance();
            })
            .catch(error => {
                console.error('Error deleting card:', error);
                showAlert('교통카드 삭제에 실패했습니다.', 'danger');
            });
        }

        // Login functions (same as in index.html)
        function requestLoginCode() {
            const email = document.getElementById('loginEmail').value.trim();
            
            if (!email) {
                showAlert('이메일을 입력해주세요.', 'warning');
                return;
            }
            
            fetch('/api/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email: email })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    showAlert(data.message, 'success');
                    document.getElementById('loginStep1').style.display = 'none';
                    document.getElementById('loginStep2').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('로그인 코드 요청에 실패했습니다.', 'danger');
            });
        }

        function verifyLoginCode() {
            const code = document.getElementById('loginCode').value.trim();
            
            if (!code) {
                showAlert('인증 코드를 입력해주세요.', 'warning');
                return;
            }
            
            fetch('/api/auth/verify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ code: code })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === 'Login successful') {
                    showAlert('로그인되었습니다.', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showAlert('잘못된 인증 코드입니다.', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('로그인에 실패했습니다.', 'danger');
            });
        }

        function backToStep1() {
            document.getElementById('loginStep1').style.display = 'block';
            document.getElementById('loginStep2').style.display = 'none';
            document.getElementById('loginCode').value = '';
        }

        function logout() {
            fetch('/api/auth/logout', { method: 'POST' })
                .then(() => {
                    showAlert('로그아웃되었습니다.', 'success');
                    setTimeout(() => location.reload(), 1000);
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('로그아웃에 실패했습니다.', 'danger');
                });
        }

        // Utility functions
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        function formatNumber(num) {
            return parseFloat(num).toLocaleString('ja-JP', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            });
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>