<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>엔화 지갑 관리 - Japan Travel Expense</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/font-awesome.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .wallet {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #f8f9fa;
        }
        .wallet-name {
            font-weight: bold;
            font-size: 1.1rem;
        }
        .wallet-balance {
            font-size: 1.25rem;
            color: #0d6efd;
            font-weight: bold;
        }
        .total-balance {
            background: linear-gradient(135deg, #fd7e14, #ffc107);
            color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="/">
                    <i class="fas fa-yen-sign me-2"></i>일본 여행 경비
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="/"><i class="fas fa-home me-1"></i>홈</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/statistics"><i class="fas fa-chart-bar me-1"></i>통계</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/transport-cards"><i class="fas fa-subway me-1"></i>교통카드</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/wallets"><i class="fas fa-wallet me-1"></i>엔화지갑</a>
                        </li>
                        {% if user %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fab fa-telegram-plane me-1"></i>{{ user.telegram_chat_id }}
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" id="logout-btn">
                                    <i class="fas fa-sign-out-alt me-2"></i>로그아웃
                                </a></li>
                            </ul>
                        </li>
                        {% else %}
                        <li class="nav-item">
                            <button class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#loginModal">
                                <i class="fab fa-telegram-plane me-1"></i>로그인
                            </button>
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <h2 class="mb-4">엔화 지갑 관리</h2>

                <!-- Total Balance Summary -->
                <div class="total-balance text-center" id="totalBalanceCard">
                    <h4 class="mb-2">총 엔화 지갑 잔액</h4>
                    <h2 class="mb-0" id="totalBalance">¥0</h2>
                </div>

                <!-- Add Wallet Button (only for authenticated users) -->
                {% if user %}
                <div class="mb-3">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addWalletModal">
                        <i class="fas fa-plus-circle me-2"></i>지갑 추가
                    </button>
                </div>
                {% endif %}

                <!-- Wallets List -->
                <div id="walletsList">
                    <!-- Wallets will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add Wallet Modal -->
    <div class="modal fade" id="addWalletModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>새 지갑 추가</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addWalletForm">
                        <div class="mb-3">
                            <label for="walletName" class="form-label">지갑 이름</label>
                            <input type="text" class="form-control" id="walletName" placeholder="예: 일본지갑, 메인지갑, 여권지갑" required>
                        </div>
                        <div class="mb-3">
                            <label for="walletBalance" class="form-label">초기 잔액 (¥)</label>
                            <input type="number" class="form-control" id="walletBalance" step="0.01" min="0" placeholder="0.00">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="addWallet()">추가</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Wallet Modal -->
    <div class="modal fade" id="editWalletModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>지갑 수정</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editWalletForm">
                        <input type="hidden" id="editWalletId">
                        <div class="mb-3">
                            <label for="editWalletName" class="form-label">지갑 이름</label>
                            <input type="text" class="form-control" id="editWalletName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editWalletBalance" class="form-label">잔액 (¥)</label>
                            <input type="number" class="form-control" id="editWalletBalance" step="0.01" min="0">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="updateWallet()">수정</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fab fa-telegram-plane me-2"></i>텔레그램 로그인
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="login-alerts"></div>
                    
                    <!-- Step 1: Request Code -->
                    <div id="login-step1">
                        <div class="text-center mb-3">
                            <i class="fab fa-telegram-plane" style="font-size: 3rem; color: #0088cc;"></i>
                            <p class="mt-2 text-muted">이메일을 입력하여 텔레그램으로 로그인하세요</p>
                        </div>
                        
                        <form id="email-form">
                            <div class="mb-3">
                                <label for="login-email" class="form-label">이메일 주소</label>
                                <input type="email" class="form-control" id="login-email" 
                                       placeholder="이메일 주소를 입력하세요" required>
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100" id="request-login-btn">
                                <i class="fas fa-paper-plane me-2"></i>
                                <span id="request-btn-text">로그인 코드 받기</span>
                            </button>
                        </form>
                        
                        <div class="alert alert-warning mt-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <small><strong>보안 알림:</strong> 여러 번 실패 시 일정 시간 접속이 제한됩니다.</small>
                        </div>
                    </div>
                    
                    <!-- Step 2: Enter Code -->
                    <div id="login-step2" style="display: none;">
                        <div class="text-center mb-3">
                            <i class="fas fa-mobile-alt" style="font-size: 2rem; color: #0088cc;"></i>
                            <h6 class="mt-2">코드를 입력하세요</h6>
                            <p class="text-muted">텔레그램으로 전송된 6자리 코드를 입력하세요</p>
                        </div>
                        
                        <form id="login-code-form">
                            <div class="mb-3">
                                <input type="text" class="form-control text-center" id="login-code" 
                                       placeholder="000000" maxlength="6" required pattern="[0-9]{6}"
                                       style="font-size: 1.5rem; letter-spacing: 0.5rem; font-weight: 600;">
                                <div class="form-text text-center">
                                    <i class="fas fa-clock me-1"></i>코드는 15분 후 만료됩니다
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-sign-in-alt me-2"></i>
                                <span id="verify-btn-text">로그인</span>
                            </button>
                            
                            <button type="button" class="btn btn-link w-100 mt-2" id="back-to-step1">
                                <i class="fas fa-arrow-left me-1"></i>다시 코드 요청
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="/static/js/jquery-3.6.0.min.js"></script>
    
    <!-- User data for JavaScript -->
    <script>
        window.currentUser = {% if user %}{{ user.telegram_chat_id | tojson }}{% else %}null{% endif %};
    </script>
    
    <!-- Wallet Management JavaScript -->
    <script>
        $(document).ready(function() {
            loadWallets();
            
            // Login functionality
            setupLoginFunctionality();
        });

        function loadWallets() {
            $.get('/api/wallets')
                .done(function(wallets) {
                    displayWallets(wallets);
                    updateTotalBalance();
                })
                .fail(function() {
                    $('#walletsList').html('<div class="alert alert-danger">지갑을 불러오는 데 실패했습니다.</div>');
                });
        }

        function displayWallets(wallets) {
            const walletsContainer = $('#walletsList');
            
            if (wallets.length === 0) {
                walletsContainer.html('<div class="alert alert-info text-center">아직 등록된 지갑이 없습니다.</div>');
                return;
            }

            let html = '';
            wallets.forEach(function(wallet) {
                html += `
                    <div class="wallet">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="wallet-name">${wallet.name}</div>
                                <div class="wallet-balance">¥${parseFloat(wallet.balance).toLocaleString()}</div>
                            </div>
                            ${window.currentUser ? `
                                <div class="btn-group">
                                    <button class="btn btn-outline-primary btn-sm" onclick="editWallet(${wallet.id}, '${wallet.name}', ${wallet.balance})">
                                        <i class="fas fa-edit"></i> 수정
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteWallet(${wallet.id}, '${wallet.name}')">
                                        <i class="fas fa-trash"></i> 삭제
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            walletsContainer.html(html);
        }

        function updateTotalBalance() {
            $.get('/api/wallets/summary')
                .done(function(data) {
                    $('#totalBalance').text('¥' + parseFloat(data.total_balance).toLocaleString());
                });
        }

        function addWallet() {
            const name = $('#walletName').val().trim();
            const balance = parseFloat($('#walletBalance').val()) || 0;

            if (!name) {
                alert('지갑 이름을 입력해주세요.');
                return;
            }

            $.ajax({
                url: '/api/wallets',
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + (localStorage.getItem('token') || '')
                },
                data: JSON.stringify({
                    name: name,
                    balance: balance
                }),
                success: function() {
                    $('#addWalletModal').modal('hide');
                    $('#addWalletForm')[0].reset();
                    loadWallets();
                    showAlert('지갑이 성공적으로 추가되었습니다.', 'success');
                },
                error: function(xhr) {
                    console.log('Error details:', xhr);
                    if (xhr.status === 401) {
                        showAlert('로그인이 필요합니다. 토큰: ' + (localStorage.getItem('token') ? '있음' : '없음'), 'danger');
                        localStorage.removeItem('token');
                        // location.reload(); // 임시로 주석 처리
                    } else {
                        showAlert('지갑 추가에 실패했습니다. 상태: ' + xhr.status + ', 응답: ' + JSON.stringify(xhr.responseJSON), 'danger');
                    }
                }
            });
        }

        function editWallet(id, name, balance) {
            $('#editWalletId').val(id);
            $('#editWalletName').val(name);
            $('#editWalletBalance').val(balance);
            $('#editWalletModal').modal('show');
        }

        function updateWallet() {
            const id = $('#editWalletId').val();
            const name = $('#editWalletName').val().trim();
            const balance = parseFloat($('#editWalletBalance').val());

            if (!name) {
                alert('지갑 이름을 입력해주세요.');
                return;
            }

            $.ajax({
                url: `/api/wallets/${id}`,
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + (localStorage.getItem('token') || '')
                },
                data: JSON.stringify({
                    name: name,
                    balance: balance
                }),
                success: function() {
                    $('#editWalletModal').modal('hide');
                    loadWallets();
                    showAlert('지갑이 성공적으로 수정되었습니다.', 'success');
                },
                error: function(xhr) {
                    console.log('Update error details:', xhr);
                    if (xhr.status === 401) {
                        showAlert('로그인이 필요합니다. 토큰: ' + (localStorage.getItem('token') ? '있음' : '없음'), 'danger');
                        localStorage.removeItem('token');
                        // location.reload(); // 임시로 주석 처리
                    } else {
                        showAlert('지갑 수정에 실패했습니다. 상태: ' + xhr.status + ', 응답: ' + JSON.stringify(xhr.responseJSON), 'danger');
                    }
                }
            });
        }

        function deleteWallet(id, name) {
            if (!confirm(`"${name}" 지갑을 삭제하시겠습니까?`)) {
                return;
            }

            $.ajax({
                url: `/api/wallets/${id}`,
                method: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + (localStorage.getItem('token') || '')
                },
                success: function() {
                    loadWallets();
                    showAlert('지갑이 성공적으로 삭제되었습니다.', 'success');
                },
                error: function(xhr) {
                    console.log('Delete error details:', xhr);
                    if (xhr.status === 401) {
                        showAlert('로그인이 필요합니다. 토큰: ' + (localStorage.getItem('token') ? '있음' : '없음'), 'danger');
                        localStorage.removeItem('token');
                        // location.reload(); // 임시로 주석 처리
                    } else {
                        showAlert('지갑 삭제에 실패했습니다. 상태: ' + xhr.status + ', 응답: ' + JSON.stringify(xhr.responseJSON), 'danger');
                    }
                }
            });
        }

        function showAlert(message, type) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            $('body').prepend(alertHtml);
            
            setTimeout(function() {
                $('.alert').fadeOut();
            }, 3000);
        }

        // Login functionality (copied from transport-cards.html)
        function setupLoginFunctionality() {
            // Email form submission
            $('#email-form').on('submit', function(e) {
                e.preventDefault();
                const email = $('#login-email').val().trim();
                
                if (!email) {
                    showLoginAlert('이메일을 입력해주세요.', 'warning');
                    return;
                }
                
                // Show loading state
                $('#request-login-btn').prop('disabled', true);
                $('#request-btn-text').text('코드 전송 중...');
                
                // Send login request
                $.ajax({
                    url: '/api/request-login',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ email: email }),
                    success: function(response) {
                        showLoginAlert(response.message, 'success');
                        $('#login-step1').hide();
                        $('#login-step2').show();
                    },
                    error: function(xhr) {
                        const response = xhr.responseJSON;
                        showLoginAlert(response?.message || '코드 전송에 실패했습니다.', 'danger');
                    },
                    complete: function() {
                        $('#request-login-btn').prop('disabled', false);
                        $('#request-btn-text').text('로그인 코드 받기');
                    }
                });
            });
            
            // Code verification form submission
            $('#login-code-form').on('submit', function(e) {
                e.preventDefault();
                const code = $('#login-code').val().trim();
                
                if (!code || code.length !== 6) {
                    showLoginAlert('6자리 코드를 입력해주세요.', 'warning');
                    return;
                }
                
                // Show loading state
                $('#verify-btn-text').text('확인 중...');
                
                // Verify login code
                $.ajax({
                    url: '/api/verify-login',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ code: code }),
                    success: function(response) {
                        // Store token
                        localStorage.setItem('token', response.token);
                        showAlert('로그인에 성공했습니다.', 'success');
                        $('#loginModal').modal('hide');
                        // Reload page to show authenticated state
                        setTimeout(() => location.reload(), 1000);
                    },
                    error: function(xhr) {
                        const response = xhr.responseJSON;
                        showLoginAlert(response?.message || '로그인에 실패했습니다.', 'danger');
                    },
                    complete: function() {
                        $('#verify-btn-text').text('로그인');
                    }
                });
            });
            
            // Back to step 1
            $('#back-to-step1').on('click', function() {
                $('#login-step2').hide();
                $('#login-step1').show();
                $('#login-code').val('');
                clearLoginAlerts();
            });
            
            // Logout functionality
            $('#logout-btn').on('click', function(e) {
                e.preventDefault();
                localStorage.removeItem('token');
                showAlert('로그아웃되었습니다.', 'info');
                setTimeout(() => location.reload(), 1000);
            });
            
            // Reset modal when closed
            $('#loginModal').on('hidden.bs.modal', function() {
                $('#login-step2').hide();
                $('#login-step1').show();
                $('#email-form')[0].reset();
                $('#login-code-form')[0].reset();
                clearLoginAlerts();
            });
        }
        
        function showLoginAlert(message, type) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            $('#login-alerts').html(alertHtml);
        }
        
        function clearLoginAlerts() {
            $('#login-alerts').empty();
        }
    </script>
</body>
</html>